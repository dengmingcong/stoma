# 功能规范：接口自动化测试框架 Stoma（仿 FastAPI 声明式定义）

**功能分支**: `milestone-0.1`  
**创建时间**: 2025-12-12  
**状态**: 草稿  
**输入**: 用户描述: "创建一个接口自动化测试框架，借鉴 fastapi 定义接口的方式，使用 pydantic 作为类型检查和序列化，但实际并不将 fastapi 作为依赖"

## 用户场景与测试（必填）

### 用户故事 1 - 声明式定义接口并生成用例（优先级：P1）

测试工程师或开发者希望以类似 FastAPI 的方式，使用函数+装饰器+模型来声明接口的请求/响应结构，并自动生成可运行的测试用例（含校验与报告）。

**为何优先**: 这是核心价值主张，决定框架的易用性与采用成本。

**独立测试**: 通过在空白项目中仅定义一个接口模型与测试声明，即可运行单条用例并得到报告，证明框架可独立工作。

**验收场景**:

1. Given 已安装框架，When 用户定义 `@endpoint` 与 `RequestModel/ResponseModel` 并注册到套件，Then 运行生成的用例可执行、并对响应进行类型与字段校验。
2. Given 请求与响应模型包含必填与可选字段，When 被测系统返回缺失或类型不符，Then 测试判为失败且报告显示差异与定位信息。

---

### 用户故事 2 - 数据驱动与参数化（优先级：P2）

用户可以为同一接口提供多组参数数据（例：不同用户、边界值），自动生成多条用例并并行或串行执行，统一收集结果。

**为何优先**: 数据驱动是接口测试的高频需求，提升覆盖率。

**独立测试**: 在单接口场景下，提供两组数据即可独立验证参数化生效与结果区分。

**验收场景**:

1. Given 同一接口绑定多组参数，When 执行测试套件，Then 报告区分每组数据的通过/失败与输入摘要。

---

### 用户故事 3 - 断言与校验策略扩展（优先级：P3）

除基于 Pydantic 的结构与类型校验外，用户可声明额外断言（如状态码、业务码、字段范围、集合包含等），并在失败时获取清晰消息。

**为何优先**: 丰富断言能力，满足复杂业务校验需求。

**独立测试**: 在任意接口上添加一条业务断言，触发失败并获得明确的失败信息。

**验收场景**:

1. Given 用户定义自定义断言函数，When 断言失败，Then 报告包含断言名称、期望与实际值对比。

### 边界场景

- 当响应返回额外未知字段时如何处理？默认忽略并在报告中提示可选设置（严格/宽松）。
- 当请求需要鉴权头但未提供时，报告需明确为前置条件失败而非接口逻辑失败。
- 当大字段（如数组/对象）差异过多时，报告需提供摘要与可展开详情。

## 需求（必填）

### 功能性需求

- **FR-001**: 框架必须提供声明式接口定义方式（装饰器+函数签名+Pydantic 模型）以描述请求与响应。
- **FR-002**: 框架必须基于 Pydantic 对请求构造与响应解析进行类型校验与序列化/反序列化。
- **FR-003**: 框架必须支持用例自动生成：由接口定义与测试套件配置生成可执行测试。
- **FR-004**: 框架必须支持数据驱动与参数化，允许同一接口多组输入自动展开。
- **FR-005**: 框架必须提供断言扩展机制，支持内置常见断言与用户自定义断言。
- **FR-006**: 框架必须生成可读的测试报告（含通过/失败统计、失败原因、差异对比、输入摘要）。
- **FR-007**: 框架不得依赖 FastAPI，但允许“受其启发”的声明风格与注解设计。命名策略采用常见动词注解与参数标识：支持 `@get`, `@post`, `@put`, `@patch`, `@delete` 以及参数来源标记 `Query`, `Body`, `Header`, `Path`，并在文档中明确说明“本框架与 FastAPI 无依赖关系，仅保留通用语义命名”。
- **FR-008**: 框架必须支持请求前后钩子（如鉴权、前置数据准备、清理）。
- **FR-009**: 框架必须支持 HTTP 方法覆盖（GET/POST/PUT/PATCH/DELETE）与可配置超时/重试。
- **FR-010**: 框架必须在响应校验中区分“结构类型错误”与“业务断言失败”，并在报告中分层呈现。

### 关键实体

- **接口定义（Endpoint）**: 名称、方法、路径、请求模型、响应模型、前后置钩子、标签。
- **请求模型（RequestModel）**: 字段、必填/可选、默认值、校验规则、示例数据。
- **响应模型（ResponseModel）**: 字段、类型、可选/严格策略、容错策略。
- **测试套件（TestSuite）**: 套件名称、包含的接口、参数化数据源、并发/串行策略、重试策略。
- **断言（Assertion）**: 断言名称、期望表达、实际取值、错误消息模板。
- **报告（Report）**: 用例级结果、套件级统计、失败详情、差异摘要、时间线。

## 成功标准（必填）

### 可度量结果

- **SC-001**: 新用户在 15 分钟内可完成从安装到运行首个用例并获取报告（可观察问卷与演示验证）。
- **SC-002**: 95% 的接口用例在 1 秒内返回并完成类型校验（以用户感知为准：结果“即时可读”）。
- **SC-003**: 数据驱动场景下，同一接口至少支持 20 组参数的批量执行与分组报告，无人工干预。
- **SC-004**: 报告可在一次演示中清晰解释至少 3 类失败（结构错误、断言失败、前置条件失败），旁观者能理解问题定位。
- **SC-005**: 通过规范化定义方式，团队引入后一周内接口测试用例产出提升 30%。

### 假设

- 默认目标为 HTTP 接口测试；非 HTTP 场景可通过用户自定义适配器扩展。
- 使用 Pydantic v2 语义进行类型定义与校验；若版本差异，需提供兼容指引。
- 报告以文件或控制台输出为主；可选集成到外部平台不在本规范范围内。
- 采用通用 RESTful 约定（状态码、JSON 载荷）；特殊协议通过扩展支持。

### 需澄清事项（最多 3 项）

+- 命名/注解可借鉴范围：采用保留常见动词注解（get/post 等）与参数标识（Query/Body 等）的策略，且在文档中声明无 FastAPI 依赖，仅为通用约定，减少迁移成本。
+- 报告形式：内置 HTML 报告文件输出（同时保留控制台摘要），以便分享与归档；HTML 报告至少包含套件统计、用例明细、失败差异对比与输入摘要。
+- 并发执行策略：默认提供并发与限流配置（如并发度、每秒请求上限），可在套件级或全局配置，满足高覆盖批量场景。
