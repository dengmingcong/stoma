# 功能规范：接口自动化测试框架 Stoma（仿 FastAPI 声明式定义）

**功能分支**: `001-generate-api`  
**创建时间**: 2025-12-12  
**状态**: 草稿  
**输入**: 用户描述: "创建一个接口自动化测试框架，借鉴 fastapi 定义接口的方式，使用 pydantic 作为类型检查和序列化，但实际并不将 fastapi 作为依赖"

## 用户场景与测试（必填）

### 用户故事 1 - 声明式定义接口并生成用例（优先级：P1）

测试工程师或开发者希望以类似 FastAPI 的方式，使用可调用对象+装饰器+模型来声明接口的请求/响应结构，并自动生成可运行的测试用例（含校验与报告）。

**为何优先**: 这是核心价值主张，决定框架的易用性与采用成本。

**独立测试**: 通过在空白项目中仅定义一个接口模型与测试声明，即可运行单条用例并得到报告，证明框架可独立工作。

**验收场景**:

1. Given 已安装框架，When 用户定义 `@endpoint` 与 `Request/Response` 并注册到套件，Then 运行生成的用例可执行、并对响应进行类型与字段校验。
2. Given 请求与响应模型包含必填与可选字段，When 被测系统返回缺失或类型不符，Then 测试判为失败且报告显示差异与定位信息。

## 需求（必填）

### 功能性需求

- **FR-001**: 框架必须支持将 OpenAPI Specification 定义的 HTTP 接口直接转换为框架对接口的定义。
- **FR-002**: 框架必须提供声明式接口定义方式以描述请求与响应。
- **FR-003**: 框架必须基于 Pydantic 对请求构造与响应解析进行类型校验与序列化/反序列化。
- **FR-004**: 框架必须生成可读的测试报告（含通过/失败统计、失败原因、差异对比、输入摘要）。
- **FR-005**: 框架不得依赖 FastAPI，但允许“受其启发”的声明风格与注解设计。命名策略采用常见动词注解与参数标识：支持 `@get`, `@post`, `@put`, `@patch`, `@delete` 以及参数来源标记 `Query`, `Body`, `Header`, `Path`，并在文档中明确说明“本框架与 FastAPI 无依赖关系，仅保留通用语义命名”。
- **FR-006**: 框架必须使用 Playwright 作为接口请求的客户端。
- **FR-007**: 框架必须提供 CLI 工具,从 OpenAPI 规范文件预先生成 Python 请求/响应模型与端点定义代码,测试运行阶段仅加载生成代码而不再解析 OpenAPI 文件。
- **FR-008**: 生成产物的目录结构必须按 feature 维度归档,每个功能一个包,至少包含 `router.py`(汇总该功能所有接口) 与 `models.py`(该功能所有接口相关模型);允许在包内扩展如 `schemas.py`, `utils.py` 等,整体参考 fastapi-best-practices 的组织方式,以提升可维护性与可发现性。
- **FR-009**: 提供命令行入口 `stoma make`,最小必需参数包括 `--spec <openapi.yaml>`、`--out <dir>`、`--feature <name>`; 其中 `--feature` 用于将同一业务域的接口与模型归档到同一包(例如 `users/`),命令执行后在输出目录按 `feature` 生成包含 `router.py` 与 `models.py` 的包结构。

### 关键实体

- **接口定义（Endpoint）**: 名称、方法、路径、请求模型、响应模型。
- **请求模型（Request）**: 字段、必填/可选、默认值、校验规则、示例数据。
- **响应模型（Response）**: 字段、类型、可选/严格策略、容错策略。

## 成功标准（必填）

### 可度量结果

- **SC-001**: 新用户在 5 分钟内可完成从安装到将 OpenAPI Specification 定义转换为框架对接口的定义。

### 假设

- 默认目标为 HTTP 接口测试；非 HTTP 场景可通过用户自定义适配器扩展。
- 使用 Pydantic v2 语义进行类型定义与校验；若版本差异，需提供兼容指引。
- 报告以文件或控制台输出为主；可选集成到外部平台不在本规范范围内。

### 需澄清事项（最多 3 项）

- 命名/注解可借鉴范围：采用保留常见动词注解（get/post 等）与参数标识（Query/Body 等）的策略，且在文档中声明无 FastAPI 依赖，仅为通用约定，减少迁移成本。
- 报告形式：内置 HTML 报告文件输出（同时保留控制台摘要），以便分享与归档；HTML 报告至少包含套件统计、用例明细、失败差异对比与输入摘要。
- 框架的作用过程可以看作 FastAPI 的反面。FastAPI 是通过模型生成 OpenAPI Specification，框架是从 OpenAPI Specification 生成模型。
	- 决策补充：采用“预先代码生成”工作流，通过 CLI 将 OpenAPI 转换为静态 Python 模型与端点定义，提升运行性能与类型安全；运行阶段不再进行动态解析。

## Clarifications

### Session 2025-12-15

- Q: OpenAPI Specification 的转换是运行时动态生成还是预先代码生成? → A: 预先代码生成
- Q: 代码生成产物的输出结构应如何组织? → A: 按 feature 归档的包结构,参考 fastapi-best-practices: 每个功能一个包,`router.py` 存放该功能所有接口,`models.py` 存放该功能所有接口相关模型,其余辅助文件同包内组织。
- Q: 代码生成 CLI 的入口命令与最小参数集合? → A: 使用 `stoma make --spec <openapi.yaml> --out <dir> --feature <name>` 形式。
